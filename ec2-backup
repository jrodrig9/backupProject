#!/usr/bin/env python

import sys
import getopt
import os
import math
import subprocess

def errorMsg(msg):
    sys.stderr.write("ERROR - " + str(msg) + "\n")
    sys.exit(1)

def existsDir(directory):
    return os.path.exists(directory) and os.path.isdir(directory)

#This function was taken from http://stackoverflow.com/questions/1392413/calculating-a-directory-size-using-python
def getDirSize(directory):
    size = 0
    for dirPath, dirNames, fileNames in os.walk(directory):
        for f in fileNames:
            filePointer = os.path.join(dirPath, f)
            size += os.path.getsize(filePointer)
    return size

def bytesToGB(size):
    return size/(1024*1024*1024)+1

def getAvailZone(availability):
    if(availability):
        for i in range(len(availability)):
            if availability[i+2] == "available":
                return availability[i+3]
            i += 4
    return "None"

def getZone(availability):
    if(availability):
        for i in range(len(availability)):
            if availability[i+2] == "available":
                return availability[i+1]
            i += 4
    return "None"

def availToZone(availZone):
    if (availZone):
        splitString = availZone.split('-')
        zone = '-'
        sequence = (splitString[0], splitString[1], splitString[2][0])
        zone = zone.join(sequence)
        return zone
    return "None"

def main(argv):
     method = ''
     volumeId = ''
     directory = ''
     try:
          opts, args = getopt.getopt(argv, "-hm:v:")
     except getopt.GetoptError:
         errorMsg("Usage: ec2-backup [-h] [-m method] [-v volume-id] dir")
     if len(args) < 1:
         errorMsg("Usage: ec2-backup [-h] [-m method] [-v volume-id] dir")
     for opt, arg in opts:
          if opt == "-h":
               print "Usage: ec2-backup [-h] [-m method] [-v volume-id] dir"
               sys.exit(0)
          elif opt == "-m":
               method = arg
               if (method != "dd" and  method != "rsync"):
                   errorMsg("The given method is not valid, please use either dd or rsync")
          elif opt == "-v":
               volumeId = arg
     #print "Method is: ", method
     #print "Volume is: ", volume
     #print args
     directory = args[0]
     if not(existsDir(directory)):
         errorMsg("The given directory does not exist: "+args[0])
     #print bytesToGB(getDirSize(directory)), "GBytes"
     volumeSize = bytesToGB(getDirSize(directory))
     #print volumeId
     if (not(volumeId)):
         availability = subprocess.check_output("aws ec2 describe-availability-zones", shell=True)
         availability = availability.split()
         availZone = getAvailZone(availability)
         #print availZone
         zone = getZone(availability)
         #print zone

     else:
         if (subprocess.call("aws ec2 describe-volumes --volume-ids "+volumeId, shell=True) > 0):
             errorMsg("The volume-id provided is not valid")
         availability = subprocess.check_output("aws ec2 describe-volumes --volume-ids "+volumeId, shell=True)
         #print "did the program continue?"
         availability = availability.rsplit()
         availZone = availability[1]
         print availZone
         zone = availToZone(availZone)
         print zone
     if ( availZone == "None" or zone == "None"):
         errorMsg("Problem retrieving a zone, is your [default zone] set on .aws/config?")
         
     
     #The amis for all instances are in a dictionary bellow: (all fedora intances)
     amis = { 
         'us-east-1': 'ami-84db39ed',  
         'us-west-2':  'ami-080f9038',
         'us-west-1': 'ami-3d3a6b78',
         'eu-west-1': 'ami-13042f67',
         'eu-central-1': 'ami-147c4109',
         'ap-northeast-1': 'ami-038d6603',
         'ap-southeast-2': 'ami-01e6963b',
         'ap-southeast-1': 'ami-83f58ad1',
         'sa-east-1': 'ami-056ecf18',
         }
     sys.exit(0)

main(sys.argv[1:])
